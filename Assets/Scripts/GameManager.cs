using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class GameManager : MonoBehaviour
{
    public static GameManager instance;
    string[] stories = { "Once upon a time there was a girl by the name of Sarah, who was in love very much. She and her partner spend everyday talking, chatting, texting, laughing, loving together. It seemed like it would never end. But, it almost came out of the blue when Sarah got the text that said:\n‘I don’t love you anymore.’\nSarah could only think of it as a joke.\n‘What do you mean? You can’t be serious right?’\n‘I’m not joking. These past few months, they have been fun\n‘ …’ \n‘but I feel like I could go for someone better, you know.”\nSarah was in shock.\n‘You … you can’t be serious. We spent so much time together, I gave you my heart, are you really going to let it go like that?’\n‘....’\n‘I’m sorry.’\nSarah didn’t know what to say. She dropped the phone onto the ground and covered her face with her hands. They had spent a year together, last week was their 1 year anniversary, and yet this is how it ends? Just like that?\nThe tears from Sarah’s face wouldn’t stop falling, and her heart felt like it was shattering into a billion pieces.\nWith the last of her energy, she messaged her boss that she was going to take a sick day tomorrow, and then jumped into bed and cocooned the blanket around her body. Within this warm cocoon, the outside world couldn’t hurt her anymore. She closed her eyes and try to sleep it off. Maybe this was all a bad dream, and it would all disappear in the morning.\n…\nBut it didn’t. The longer she stayed in bed, the harder it became to deny that this happened. Every time she looked at the phone, she was constantly reminded by what happened. She just wanted to scream into a pillow, but she couldn’t. The walls were thin, and the people next door could hear. All she could do right now was to bottle this righteous anger that was boiling inside of her.\n …… \n On an island in Sarah’s dreamscape, a fox was peacefully napping when suddenly the island he was sitting on suddenly broke apart into three pieces. As the fox looked overhead, she saw the memories of Sarah’s relationship fall from the sky and land on each of the different islands. The fox got up and brushed herself off, and then decided to chase after the memories, hoping to use them to fix the islands.",
    "The fox collected the memory of the ice cream and realized that it was Sarah’s memory of her first date with her ex-partner. Sara had noticed her in class but been afraid to ask her out. To her surprise, they accepted and suggested that they should have the date at Ben and Jerry’s, even though it was wintertime. Without thinking Sarah accepted. She got her roommate to help pick out the perfect dress that she could impress them with and trying out different colors of makeup and shit. Her roommate laughed and told her to just show her best self.\nShe walked into the ice cream shop overdressed as all hell. Perfume, gel, fancy clothes, the whole nine yards. As soon as she walked in, it felt like everyone was just staring at her, and she felt super self-conscious. Her face turned bright red, and she walked over to the far end of the shop and sat down on the chairs right next to the window, and looked to the window.\nIt didn’t take long for the bells to jingle and SHE walked in. Her crush was there, in person, to specifically see HER. Unlike Sarah, they had dressed pretty plainly: jeans, a faded Sailor Moon t-shirt, and a denim jacket. And, like always, she was wearing her stupid baseball cap with the Japanese words for idiot labeled on it. \nShe looked right at Sarah and burst out laughing.\n“What are you doing, Sal? This is an ice cream shop, not a fancy dinner.”\nShe sat down right next to her, still laughing her ass off.\n“I - I can’t believe - oh lord….”\nSarah could only just stare at her like always. Her freckles were as cute as ever, and today she was wearing her hair in a ponytail. A part of her still couldn’t believe that she was currently on a date with this f*cking Aphrodite. \nPresently, her crush caught her staring at her.\n“What you looking at?”\n“I … uh ….”\nThis only made her laugh even harder and then started talking all through the night. By the time they had finished, Sarah realized that everyone had already left, and the ice cream shop was going to close.\n“Aw, geez, Sal, it’s way too late now. Ah well.”\nShe got up, and, with a twinkle in her eyes, said:\n“Hey, Sal? Do you want me to drive you back to the dorm”\nSal gasped “Uh, sure? I mean, I wouldn’t mind.”\nSal and her crush got up as her crush spun her car keys around her finger as they both walked towards the car. Her crush stopped right in front of a beat-up red 2005 Honda civic and opened the door for her.\n“Ladies first.”\nSarah got in as she started the car and began driving.\n“Tonight was fun, huh?”\n“Y-yeah … it was.”\nShe stopped right in front of her dorm hall, then turned to face Sarah.\n“Hey, you know what, do you want to stay over at my place?”\nSal’s face turned beet red.\n“I, uh, I mean, I guess I could, but my roommate -”\nShe laughed again.\n“I’m just kidding, dude.”\nAnd, before Sarah could react, her crush kissed her on the check.\n“Catch you tomorrow in class alright?”\nSarah’s heart skipped a beat.\n“Y - yeah.”\nAs Sarah got out of the car, she started almost skipping towards her dorm room. She couldn’t believe it! Her crush actually liked her. Oh, her roommate would be so jealous when Sarah told her tomorrow.\n….\nThe fox watched this all unfold, and it felt sorry for its master. Something started out so innocent, yet it would lead to such heartbreak. As the fox snapped back to reality, it realized that another island popped up. Getting up, it decided to head to the next island.\n",
    "The fox picked up the memory of the lipstick, and as it held it in her hands, she saw another memory of Sarah and her ex-partner.\nThey had been dating for a month now, but for some reason, they hadn’t kissed yet. Well, they had kissed, but Sarah was aching for a real kiss with her partner. Something that was super romantic but super romantic at the same time. The stuff that she could brag to her friends about. \nWhen her partner arrived to pick her up in her car, Sarah was determined by the end of this date to make out with her. Her partner wanted to do something different and so she wanted to have a little evening picnic in a park. Sarah this time had made extra sure to look as kissable as possible, so she had put on a super expensive red lipstick that she bought at Macy’s the last time she went shopping with her friends.\nHer partner was oddly quiet while she was driving. The music was on (she was playing a song that had some rap artist crooning over autotune) but it felt like the air in the car was super tense. Sarah felt her heart was pounding like crazy for no reason as her partner stopped the car and open the door for her to get out.\nWhen Sarah got out of the car, she realized that her partner had parked the car in front of a cliffside overlooking the city. \n“Uh, what are we doing here, -?” Sarah turned to look at her partner only to see that she also looked incredibly nervous.\n“Ehehehehe…. Sorry, Sal, I didn’t actually want to have a picnic.”\n“Then why did you bring me up here then?”\n“Well, I, uh, oh screw it.”\nBefore Sarah could react, her partner kissed her right on her lips while the sun was setting. It was the most magical goddamn moment a person could wish for.\nWhen they had separated, the sun had already gone down.\n“I, uh, wow” Sarah was at a loss for words.\nHer partner grinned sheepishly\n“I wanted our first kiss to be special. I hope that was special enough for you to never forget this moment.”\n…..\nAs the fox felt the memory leave her, she realized that no, Sarah never truely did get over this very special moment. The fox still had no idea why her partner left her, but she was determined to find out why.\n",
    "This wasn’t a good memory, and yet, it was a very important one.\nIt was the memory of their first fight.\nIt was a day just like any other, Sarah was over at her place, and was on the couch eating a bag of chips while playing a game on the TV. Her partner walked in and saw Sarah using her controller.\n“What are you doing?”\nSarah looked up.\n“What do you mean what I’m doing?”\n“Why are you using my controller with your slimly oily hands? I have told you multiple times to wash your damn hands before using my stuff!”\n“I’m sorry, I just -”\n“You are CONSTANTLY leaving stuff all over the damn place. Every time you come over to my place you make it look like a goddamn pigsty.”\n“I’m SORRY, I just -”\n“And WHY ARE YOU ALWAYS AT MY PLACE?? It’s like everyday you COME OVER HERE and USE MY STUFF. WHY CAN’T YOU JUST LEAVE ME THE FUCK ALONE FOR ONCE. I am TIRED of ALWAYS having to clean after you.”\n“I just … I just always want to be next to you….”\n“I DONT!”\nThere was a pregnant pause.\n“I don’t want to be this close to you. We are moving too fast, man. I still want some goddamn me time.”\n______\nThe fox realized that Sarah never listened; she never really respected her partner’s personal space. Sarah was so into her partner, she almost oppressed her with the amount of attention that she was giving her. If she had only learned to dial it back, maybe the relationship could have still worked.\n",
    "This memory the fox collected was of a text conversation that Sarah and her partner had with each other. Her partner had gone on a trip to a game developer conference to promote the indie game she was developing.\n“Hey babe, did you reach yet?” Sarah had texted when her partner left for her trip.\nNo response.\n“Hey?” Sarah wrote again\n“Hey babe, are you there yet?”\n“Hey babe, can you respond?”\n“Hey. Hey. Hey. Hey.”\nSarah continued to message her until her partner finally snapped and wrote back\n“WHAT?????????”\n“What? I was just worried about you….”\n“So you couldn’t wait for FIVE MINUTES???”\n“I’m sorry babe, but I miss you.”\n“Yeah, yeah, I miss you too ok? Now can you please stop texting me?”\nIt took only ten minutes for Sarah to disregard this and get right back to texting her. She wouldn’t leave her alone the entire time her partner was there.\nWhen her partner sent a picture of her with someone else, Sarah immediately jumped to the worst possible scenario.\n“Who the hell is this? Have you been talking to someone without me? Is that the reason that you went to the convention?”\n“What? No!”\n“I can see it now, you’ve been ignoring me and been hanging out with this girl instead!”\n“Godamn it no! She’s literally just the person that made my favorite game. You know, the game that we played together? I can’t believe that you would …. I’m turning my phone off.”\n_________\nThe fox realized that Sarah’s jealousy and possessiveness were poisoning the relationship, and that slowly but surely, Sarah’s selfishness was eroding her partner’s love. The last memory, then, would be the final straw. \n",
                           "Sarah and her partner’s relationship had been deteriorating for a few months now, but this only made Sarah even more possessive, trying desperately to win her back, not understanding that this behavior is what drove her away in the first place.\nThis behavior came to a head when Sarah secretly sneak into a game industry mixer that her girlfriend was at that was held at a bar nearby. When Sarah got there, her partner was already talking to another girl. They were laughing and chatting, and her partner looked happier with her than she did with Sarah in months. Sarah got angry, and decided to go straight up to them.\n“Hey!”\nHer partner froze, then turned around from her conversation to see Sarah standing there.\n“S-sarah? What the hell are you doing here? You scared the ever-loving shit out of me.”\n“What the hell are you doing talking to her, without me. Who is this … this vixen?”\nSarah grabbed her partner’s arm.\n“Come on, you and me, we are going to have a talk?”\n“Yo, who the hell is she?” The person her partner was talking to said.\n“She’s my girlfriend, but right now, she’s being REALLY IRRITATING!.”\n“You’re being irritating since you are CHEATING on me!”\n“God DAMN it Sarah, I’m not cheating on you! She’s a recruiter for Blizzard, and I just wanted to talk about my game with her, but then you had to barge in here and fuck everything up. Screw this, I’m leaving. Don’t follow me.”	\n________\nThis was only a few weeks before the breakup, and yet the fox could tell this was the final straw for Sarah’s partner. This was undoubtedly the main reason why Sarah and her partner broke up.\n"};

    public GameObject firstIsland;
    public GameObject secondIsland;
    public GameObject thirdIsland;
    public GameObject level1;
    public GameObject platformX1;
    public Transform reset;
    public Transform finish1;
    public Transform reset2;

    public bool finishOneTime = false;
    public bool resetOneTime = false;
    public int score = 0;

    public Text scoreText;
    public Image endImage;

    public const int scoreToYellowFirst = 3;
    public const int scoreToSecondIsland = 6;
    public const int scoreToYellowSecond = 9;
    public const int scoreToThirdIsland = 12;
    public const int scoreToYellowThird = 15;
    public const int scoreToFinish = 18;

    public Texture[] firstTextures;
    public Texture[] secondTextures;
    public Texture[] thirdTextures;

    public Text text;

    public GameObject player;
    public Transform startTrans;

    // current level of the game
    public int level = 0;

    public void Awake()
    {
        instance = this;
    }

    public void ResetToStart()
    {
        player.transform.position = startTrans.position;
    }

    public void LevelTransition(int level)
    {
        if (level == 0)
        {
            // level 1 falls down
            foreach (Transform child in level1.transform)
            {
                StartCoroutine(PlatformFallingIE(child.gameObject, reset));
            }
            ChangeIslandColor(0, 1);

            // platform x moves to island2
            var movement = platformX1.GetComponent<PlatformMovement>();
            movement.isMoving = false;
            movement.start = movement.gameObject.transform.position;
            movement.end = reset2.position;
            movement.speed = 0.1f;
            movement.isMoving = true;

            // island 2 rising
            secondIsland.gameObject.SetActive(true);
        }

        Invoke("Ending", 5f);
        
    }


    public void Ending()
    {
        endImage.gameObject.SetActive(true);
    }

    IEnumerator PlatformFallingIE(GameObject platform, Transform end)
    {
        float a = 2f;
        float v = 0;
        float y = platform.transform.position.y;
        while (Vector3.Distance(platform.transform.position, end.position) > 0.1f)
        {
            float t = Time.deltaTime;
            v += a * t;
            y -= v * t + 0.5f * a * t * t;
            platform.transform.position = new Vector3(platform.transform.position.x, y, platform.transform.position.z);
            yield return null;
        }
    }


    public void ChangeIsland(int score)
    {
        switch (score)
        {
            case scoreToYellowFirst:
                ChangeIslandColor(0, 1);
                break;

            case scoreToSecondIsland:
                ChangeIslandColor(0, 2);
                ShowSecondIsland();
                ChangeIslandColor(1, 0);
                break;

            case scoreToYellowSecond:
                ChangeIslandColor(1, 1);
                break;

            case scoreToThirdIsland:
                ChangeIslandColor(1, 2);
                ShowThirdIsland();
                ChangeIslandColor(2, 0);
                break;
            case scoreToYellowThird:
                ChangeIslandColor(2, 1);
                break;
            case scoreToFinish:
                ChangeIslandColor(2, 2);
                break;
        }
    }

    public void ShowStory(int score)
    {
        if (score < stories.Length)
        {
            text.text = stories[score + 1];
        }
        else
            Debug.LogError("score out of story length!");
    }


    public void ShowSecondIsland()
    {
        secondIsland.SetActive(true);
    }
    public void ShowThirdIsland()
    {
        thirdIsland.SetActive(true);
    }

    public void ChangeIslandColor(int i, int j)
    {
        switch (i)
        {
            case 0:
                firstIsland.GetComponent<Renderer>().material.SetTexture("_MainTex", firstTextures[j]);
                if (j == 0) 
                {
                    PlayAudio.instance.PlayTexture1();
                    PlayAudio.instance.PlaySad();
                    Debug.Log("Texture 1, Sad, Sand");
                }
                if (j==1)
                {
                    PlayAudio.instance.PlayTexture2();
                    PlayAudio.instance.PlayHappy();
                    Debug.Log("Texture 2, Happy, Dry Grass");

                }

                if (j==2)
                {
                    PlayAudio.instance.PlayTexture3();
                    PlayAudio.instance.PlayHappy();
                    Debug.Log("Texture 3, Happy, Grass");
                }
                break;
            case 1:
                secondIsland.GetComponent<Renderer>().material.SetTexture("_MainTex", secondTextures[j]);



                break;
            case 2:
                thirdIsland.GetComponent<Renderer>().material.SetTexture("_MainTex", thirdTextures[j]);



                break;
        }
    }

    // Start is called before the first frame update
    void Start()
    {
        firstIsland.SetActive(true);
        ChangeIslandColor(0, 0);
        secondIsland.SetActive(false);
        thirdIsland.SetActive(false);

        ResetToStart();
    }

    // Update is called once per frame
    void Update()
    {        
        if (player.transform.position.y > finish1.position.y)
        {
            if (level == 0 && finishOneTime == false)
            {
                finishOneTime = true;
                LevelTransition(level);
                level++;

            }
        }

    }

    void LateUpdate()
    {
        if (player.transform.position.y < reset.position.y)
        {
            ResetToStart();
            player.GetComponent<CharacterController>().enabled = false;
            player.GetComponent<CharacterController>().enabled = true;

        }
    }
}
